# Story 1.3: Super Admin Authentication

## Status
Approved

## Story
**As a** Super Admin,
**I want** to securely log in to a dedicated super admin dashboard,
**so that** I can manage the platform.

## Context Source
- Source Document: `docs/prd/06-section-6-epic-details.md` (Epic 1 – Platform Foundation & University Onboarding)
- Supplementary Architecture: `docs/architecture/05-api-specification.md`, `docs/architecture/11-backend-architecture.md`, `docs/architecture/15-security-and-performance.md`, `docs/architecture/12-unified-project-structure.md`
- UI/UX Specification: `docs/front-end-spec.md`
- Existing System Impact: Introduces the platform’s first production authentication flow; touches backend security services, frontend routing/guards, token issuance, Redis rate limiting, and deployment runbooks for seeded credentials.

## Dependencies
- Story 1.1: Project Initialization (monorepo scaffolding and app shells)
- Story 1.2: Database and AI Environment Setup (database schema, Alembic, worker image)

## Acceptance Criteria
1. A dedicated Super Admin login experience exists at `/super-admin/login`, rendered inside the `AuthLayout`, and exposes a password form followed by a six-digit PIN step with full keyboard/accessibility support.
2. Submitting valid credentials to `POST /api/v1/super-admin/login/password` verifies against the `super_admins` table using bcrypt hashes, enforces account status (`active` only), increments a per-user failed-attempt counter, and returns a signed, single-use MFA token (`mfaToken`) with a five-minute TTL when successful.
3. The frontend consumes the `mfaToken`, presents the PIN interface, and calls `POST /api/v1/super-admin/login/pin` with the token and PIN; the backend validates the token signature/expiration and the hashed PIN, returning JWT access/refresh tokens (refresh via `HttpOnly` cookie, access token in body) and resetting failed-attempt counters.
4. On success, the frontend persists the access token in memory (`AuthContext`), acknowledges the refresh cookie (`withCredentials` requests), hydrates the authenticated Super Admin profile, and redirects to `/super-admin/dashboard` behind the existing `RouteGuard`.
5. Authentication failures (invalid password, locked account, expired/invalid MFA token, incorrect PIN) respond with descriptive but non-sensitive error codes/messages, drive consistent UI feedback (inline error + toast), and lock the account after five consecutive failures until an administrator resets it.
6. Sensitive endpoints (`/super-admin/login/password` and `/super-admin/login/pin`) are protected by SlowAPI rate limiting (default 5 attempts/minute per IP + user) and emit structured audit logs for successful and failed attempts (action, actor email, IP, outcome, timestamp).
7. A manual seeding script exists to create the initial Super Admin, invoked via `docker compose run api python -m scripts.create_super_admin --email ...`, securely hashing both password and PIN, and the deployment guide documents its usage and rotation expectations.

## Non-Functional Requirements & Constraints
- Security: Must comply with `docs/architecture/15-security-and-performance.md` (bcrypt hashing, tokenVersion invalidation, HttpOnly refresh cookies, strict rate limits).
- Reliability: MFA token TTL and account lockouts must be configurable via environment variables and covered by automated tests.
- Maintainability: Follow the monorepo layout, place new backend modules in `apps/api/src` per architecture guidance, and co-locate frontend components under `apps/web/src/app/super-admin/login` with supporting hooks/services.
- Observability: Emit FastAPI structured logs (JSON) and increment Prometheus counters for login successes/failures; surface a TanStack Query devtools note for QA to verify state transitions.
- Accessibility & UX: Enforce focus traps, visible focus rings, form labels, WCAG-compliant error messaging, and follow the Inter/Tailwind brand palette from `docs/front-end-spec.md`.

## Dev Technical Guidance

### Existing System Context
- Backend authentication service resides in `apps/api/src/services/auth`, consuming repositories in `apps/api/src/repositories` and shared security helpers in `apps/api/src/core/security.py`.
- Frontend authentication flows use React Router layouts defined under `apps/web/src/app` and share context via `apps/web/src/context/auth-context.tsx` (created in Story 1.1 scaffolding).
- Redis is available for rate limiting and session instrumentation via `docker-compose`.

### Data & Domain Model
- `super_admins` table columns (`email`, `password_hash`, `pin_hash`, `status`, `token_version`, timestamps) are defined in `docs/architecture/04-data-models.md` and materialized by Story 1.2 migrations. Passwords and PINs must be hashed with `passlib[bcrypt]`; plain values are never persisted or logged.
- Store the MFA token as a signed JWT (`python-jose`) embedding `super_admin_id`, `token_version`, and expiration. No database persistence is required, but claims must be validated against current DB values.
- Increment `token_version` upon password/PIN reset operations (future stories) to invalidate old sessions.

### Backend Implementation Plan
1. **Routing & Schemas**
   - Create `apps/api/src/api/v1/super_admin/auth.py` with two FastAPI routes mapped to the API spec. Import within `apps/api/src/api/v1/router.py`.
   - Define Pydantic request/response schemas in `apps/api/src/schemas/super_admin_auth.py` enforcing email format, password policy, and PIN regex.
2. **Service Layer**
   - Implement `apps/api/src/services/super_admin_auth_service.py` encapsulating:
     - Password verification via `verify_password` helper.
     - Account status checks and failed-attempt bookkeeping (store counters in `super_admin_security_events` table or Redis key namespace like `failed:super-admin:{id}` with TTL).
     - MFA token creation using `create_token(data, expires)` helper with a 5-minute expiration.
     - PIN verification using constant-time comparison of bcrypt hashes; optionally seed `pyotp` integration for future TOTPs by abstracting the verification function.
     - Audit logging via repository (e.g., `audit_log_repository.create_login_attempt`).
3. **Rate Limiting & Dependencies**
   - Apply `@limiter.limit("5/minute")` decorator from SlowAPI for both routes, using a key function that combines IP and email (where available) to satisfy NFR12.
   - Leverage FastAPI dependency injection to fetch DB session and limiter.
4. **Error Handling**
   - Follow `docs/architecture/18-error-handling-strategy.md`: raise `HTTPException` with standardized `detail` payloads and `code` values (e.g., `AUTH_INVALID_CREDENTIALS`, `AUTH_ACCOUNT_LOCKED`, `AUTH_INVALID_MFA_TOKEN`).
   - Include retry-after headers when throttled.
5. **Session Issuance**
   - On success, issue access token (15 min) and refresh token (7 days) per architecture. Set refresh token via `Response.set_cookie` with `HttpOnly`, `Secure`, `SameSite="strict"`, and `Path="/api"`.
   - Return JSON body `{ "accessToken": "...", "expiresIn": 900 }` and include minimal Super Admin profile snapshot if needed by frontend hydration.
6. **Seeding Script**
   - Add `apps/api/scripts/create_super_admin.py` with argparse CLI (email, password, pin). Use Alembic models/SQLAlchemy session to upsert the record and print success instructions. Document in README deployment section.

### Frontend Implementation Plan
1. **Routing & Layout**
   - Add Next.js/React route at `apps/web/src/app/super-admin/login/page.tsx` using the existing `AuthLayout`. Ensure metadata updates for SEO/accessibility.
2. **Components**
   - Build `PasswordStep` and `PinStep` components in `apps/web/src/components/auth/super-admin/`. Compose them in a parent `SuperAdminLoginForm` controlling state.
   - Use `shadcn/ui` primitives: `<Card>`, `<CardHeader>`, `<CardContent>`, `<Label>`, `<Input>`, `<Button>`, `<Form>`, `<FormField>`, `<FormMessage>`, `<Separator>`.
   - Implement masked PIN inputs using either `InputOTP` from `shadcn/ui` or a custom 6-field component honoring keyboard navigation.
3. **Form Logic & Validation**
   - Use `React Hook Form` with `zodResolver`. Password step schema enforces email format and minimum 12-character policy; PIN schema enforces 6 numeric digits.
   - Manage multi-step transitions locally; on successful password mutation, store `mfaToken` in state and focus first PIN field.
4. **API Integration**
   - Add `superAdminAuthService` module under `apps/web/src/services/` using the shared API client. Configure `withCredentials: true` for the PIN step call to receive cookies.
   - Handle success by calling `authContext.signIn({ role: "super-admin", accessToken, profile })`, priming TanStack Query caches (e.g., prefetch `super-admin/me`).
5. **Error & Loading States**
   - Display inline errors under fields plus a toast using the existing `useToast` hook. Provide `Forgot PIN?` help text linking to future recovery flow (disabled until implemented).
   - Disable submit buttons during pending states and show spinner icons per UI spec.
6. **Accessibility & Responsiveness**
   - Ensure tab order flows logically; support Enter to submit each step; maintain focus outlines and aria-live region for error messaging.
7. **State Persistence**
   - Do **not** store tokens in localStorage. Access token remains in React state; refresh cookie handled automatically.
   - Clear sensitive state on unmount and when navigating away.

### Observability & Audit
- Introduce backend logging via `structlog` (already configured) with event keys `event="super_admin_login"`, `outcome`, `super_admin_id`, `remote_ip`.
- Emit Prometheus counters (e.g., `super_admin_login_attempts_total{outcome="success"|"failure"}`) in FastAPI instrumentation module.
- Frontend should log analytics event via internal telemetry hook once the dashboard loads (for QA verification).

## Tasks / Subtasks
- [ ] **Task 1: Backend Password Authentication Endpoint (AC: 2, 5, 6)**
  - [ ] Create request/response schemas in `apps/api/src/schemas/super_admin_auth.py`.
  - [ ] Implement service logic in `apps/api/src/services/super_admin_auth_service.py` for password verification, throttling, and MFA token issuance.
  - [ ] Add FastAPI route in `apps/api/src/api/v1/super_admin/auth.py` and include it in the API router.
  - [ ] Write unit tests in `apps/api/tests/super_admin/test_login_password.py` covering success, invalid credentials, locked status, and throttle behavior.
- [ ] **Task 2: Backend PIN Verification Endpoint (AC: 3, 4, 5, 6)**
  - [ ] Extend service to validate MFA token signature/expiry and compare PIN hashes.
  - [ ] Issue JWTs and refresh cookies, reset failure counters, and record audit logs.
  - [ ] Add integration tests in `apps/api/tests/super_admin/test_login_pin.py` verifying happy path, invalid token, expired token, incorrect PIN, and lockout reset.
  - [ ] Add API schema documentation (OpenAPI tags/descriptions) aligned with architecture spec.
- [ ] **Task 3: Rate Limiting & Audit Instrumentation (AC: 5, 6)**
  - [ ] Configure SlowAPI limiter with combined IP/email keys and custom error responses.
  - [ ] Persist audit events using repository or SQLAlchemy model in `apps/api/src/models/security.py`.
  - [ ] Expose Prometheus metrics counters and ensure they register on app startup.
- [ ] **Task 4: Frontend Super Admin Login UI (AC: 1, 5)**
  - [ ] Create route page, layout, and form components with styling per UI spec.
  - [ ] Implement React Hook Form + Zod validation and multi-step state machine.
  - [ ] Ensure focus management, keyboard navigation, and accessible error messaging.
- [ ] **Task 5: Frontend API Integration & Auth Context (AC: 3, 4)**
  - [ ] Add service functions using TanStack Query mutations with success/error handling.
  - [ ] Update `AuthContext` to accept Super Admin JWT payloads and prime required queries.
  - [ ] Implement redirect + toast notifications, and add Vitest + MSW tests covering success/failure flows.
- [ ] **Task 6: Initial Super Admin Seeding & Documentation (AC: 7)**
  - [ ] Implement CLI seeding script and add invocation instructions to `README.md` deployment section.
  - [ ] Provide `.env` variables for default lockout thresholds and MFA TTL with sane defaults.
  - [ ] Document operational runbook for resetting locked accounts.
- [ ] **Task 7: End-to-End & Accessibility Testing (AC: 1-6)**
  - [ ] Write backend integration smoke test hooking both endpoints to ensure full flow.
  - [ ] Add Cypress E2E scenario for Super Admin login using MSW/Playwright-style intercepts and `cypress-axe` checks.
  - [ ] Execute axe accessibility audit locally and attach report for QA review.

## Testing Strategy
### Automated Tests
- **Backend Unit Tests:** Cover password hash verification, MFA token issuance/validation, lockout thresholds, rate-limit error payloads, and JWT claims.
- **Backend Integration Tests:** Use test database to run full password + PIN flow, ensuring cookies are set, audit rows written, and counters reset.
- **Frontend Unit Tests (Vitest + MSW):** Validate form validation rules, step transitions, error messaging, and successful state hydration.
- **Frontend Integration Tests:** Simulate full login using `@testing-library/react` with mocked services to ensure redirect and context update.
- **E2E Tests (Cypress + cypress-axe):** Run against local stack, verifying WCAG 2.1 AA compliance, cookie issuance, and dashboard redirect.

### Manual / Exploratory Tests
- Verify rate limiting triggers after exceeding configured attempts (API returns 429 with Retry-After) and UI communicates cooldown.
- Validate account lockout after consecutive failures persists across sessions and resets after successful login.
- Confirm refresh token rotation by calling the `/auth/refresh` endpoint post-login and observing new access token issuance.
- Perform security smoke checks (missing headers, invalid token tampering) to ensure 401 responses and audit entries.

### Non-Functional Verification
- Monitor Prometheus metrics to confirm counters increment.
- Use browser devtools to confirm refresh cookie flags (HttpOnly, Secure, SameSite) and absence of tokens in localStorage/sessionStorage.
- Confirm login page passes Lighthouse performance/accessibility budget for unauthenticated routes.

## Rollout & Operational Notes
- Coordinate first deployment with operations to run the seeding script and store credentials securely (password manager, rotated after first login).
- Provide runbook instructions for unlocking accounts via CLI or admin console.
- Ensure environment variables (`SUPER_ADMIN_LOGIN_RATE_LIMIT`, `SUPER_ADMIN_MAX_ATTEMPTS`, `SUPER_ADMIN_MFA_TTL_SECONDS`) are added to configuration management and `.env.example`.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-12 | 1.1 | Expanded story with detailed technical guidance, security requirements, and testing strategy for implementation. | James (Dev Lead) |
| 2025-10-11 | 1.0 | Initial draft of the story. | Bob (Scrum Master) |

## QA Results
### Review Date: 2025-10-11
### Reviewed By: Quinn (Test Architect)

**Story Draft Assessment**
- Requirements Traceability: Excellent—tasks map directly to acceptance criteria and architecture references.
- Technical Guidance & Alignment: Excellent—story aligns with security architecture, REST API spec, and frontend UX standards.
- UI/UX Specification Alignment: Excellent—branding, accessibility, and component usage conform to `front-end-spec.md`.
- Testability: High—comprehensive automated and manual testing guidance reduces implementation risk.
- Risk Mitigation: Good—password hashing, MFA, rate limiting, and audit logging are called out explicitly.

**Improvements Checklist**
- [ ] Keep environment variable defaults in sync across `apps/api` settings and documentation when rotating security policies.
- [ ] Coordinate with DevOps on Prometheus alert thresholds for repeated failed logins to detect brute-force attempts.

**Gate Status**
- Gate: PASS
- Reason: The story is implementation-ready with security, UX, and testing concerns addressed.

**Recommended Status**
- [✓] Ready for Approved status.

## Dev Agent Record
### Agent Model Used
- GPT-5 (Codex CLI) — Full Stack Developer persona (James)

### Completion Notes
- Consolidated architecture, security, and UX requirements into actionable backend/frontend plans.
- Highlighted operational guardrails (rate limiting, audit logs, seeding script) to prevent regressions.
- Added multi-layered testing expectations (unit, integration, E2E, accessibility) for QA traceability.

### File List
- docs/stories/1.3.Super_Admin_Authentication.md
