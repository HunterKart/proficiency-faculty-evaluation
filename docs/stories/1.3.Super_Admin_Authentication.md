# Story 1.3: Super Admin Authentication

## Status
Approved

## Story
**As a** Super Admin,
**I want** to securely log in to a dedicated super admin dashboard,
**so that** I can manage the platform.

## Acceptance Criteria
1. A login form is available for Super Admins.
2. The system authenticates credentials against the `super_admins` table.
3. After successful password validation, the system prompts the Super Admin to enter their 6-digit PIN code for multi-factor authentication.
4. Upon successful PIN verification, the user is redirected to the Super Admin dashboard.
5. Failed login attempts (either password or PIN) display a clear error message.
6. **Developer Note:** The initial Super Admin account will be created via a secure, one-time database seeding script that is run manually upon initial deployment.

## Tasks / Subtasks
- [ ] **Task 1: Create Super Admin Login Page (AC: 1)**
    - [ ] Create a new route and page component for the Super Admin login at `/super-admin/login`.
    - [ ] Design the page using `shadcn/ui` components, including `<Card>`, `<Input>`, and `<Button>`.
    - [ ] The page must contain fields for email/username and password.
    - [ ] Ensure the form adheres to the project's branding and style guide (Inter font, primary blue for the button). [Source: `docs/front-end-spec.md#section-6-branding--style-guide`]
    - [ ] Ensure all interactive elements have clear focus states and labels for accessibility. [Source: `docs/front-end-spec.md#section-7-accessibility-requirements`]

- [ ] **Task 2: Implement Password Authentication API Endpoint (AC: 2)**
    - [ ] Create a new API endpoint (e.g., `POST /api/v1/super-admin/auth/login-password`) to handle the initial password authentication.
    - [ ] The endpoint must validate the provided credentials against the `super_admins` table.
    - [ ] Use a secure password hashing and verification library (e.g., `passlib`).
    - [ ] On success, return a temporary token or session identifier to proceed to the PIN step.
    - [ ] On failure, return a `401 Unauthorized` error with a generic error message.

- [ ] **Task 3: Implement Frontend Password Authentication Logic (AC: 2, 5)**
    - [ ] Use `TanStack Query` mutations to call the password authentication endpoint.
    - [ ] On successful authentication, transition the UI to a new view/component to enter the PIN.
    - [ ] On failure, display a clear error message using a `shadcn/ui` `<Toast>` or an inline alert.

- [ ] **Task 4: Implement PIN Authentication UI and API (AC: 3, 4)**
    - [ ] Create the UI component for the 6-digit PIN entry. Use `shadcn/ui`'s `<Input type="otp">` if available, or a series of single-character inputs.
    - [ ] Create a new API endpoint (e.g., `POST /api/v1/super-admin/auth/login-pin`) that accepts the temporary token and the 6-digit PIN.
    - [ ] The endpoint must validate the PIN against the `super_admins` table.
    - [ ] On successful PIN validation, create a secure, long-lived session for the user (e.g., using JWT or session cookies) and return it.
    - [ ] On failure, return a `401 Unauthorized` error.

- [ ] **Task 5: Implement Frontend PIN Authentication and Redirection (AC: 4, 5)**
    - [ ] Use `TanStack Query` mutations to call the PIN authentication endpoint.
    - [ ] On success, securely store the session token and redirect the user to the Super Admin dashboard (`/super-admin/dashboard`).
    - [ ] On failure, display a clear error message and allow the user to retry.

- [ ] **Task 6: Create Initial Super Admin Seeding Script (AC: 6)**
    - [ ] Create a manual, one-time script (e.g., a Python script using SQLAlchemy) that can be executed to create the first Super Admin user.
    - [ ] The script must securely hash the password and PIN provided as arguments.
    - [ ] Add instructions on how to run this script to the `README.md` or a separate deployment guide.

- [ ] **Task 7: Unit and Integration Testing (AC: 1-5)**
    - [ ] Write frontend unit tests for the login form, PIN entry, and state transitions using `vitest` and `msw`. [Source: `docs/architecture/16-testing-strategy.md`]
    - [ ] Write backend unit tests for the password and PIN validation logic.
    -   [ ] Write backend integration tests for the complete login flow API endpoints.
    - [ ] Ensure all tests adhere to the project's testing strategy and file location conventions. [Source: `docs/architecture/12-unified-project-structure.md`]

## Dev Notes
This story implements the complete, two-factor authentication flow for Super Admins.

### **Relevant Architecture & UI/UX Specifications:**

-   **UI Components:** All UI must be built using `shadcn/ui` primitives and styled with Tailwind CSS. The login flow should be contained within a `Card` component for a clean, professional look. [Source: `docs/front-end-spec.md#section-5-component-library--design-system`]
-   **API Style:** The API endpoints should be synchronous and follow the established RESTful conventions. [Source: `docs/prd.md#section-4-technical-assumptions`]
-   **Data Models:** The authentication logic will interact with the `super_admins` table. Ensure the backend logic correctly queries this table. [Source: `docs/architecture/04-data-models.md`]
-   **State Management:** Frontend state for the multi-step form (password entry -> PIN entry) should be managed locally within the component. `TanStack Query` will manage API state (loading, error, success). [Source: `docs/prd.md#section-4-technical-assumptions`]
-   **File Locations:**
    -   Frontend components should be located in `apps/web/src/components/auth/`.
    -   The login page should be at `apps/web/src/app/super-admin/login/page.tsx`.
    -   Backend API routes should be in `apps/api/src/api/v1/super_admin/auth.py`.
    [Source: `docs/architecture/12-unified-project-structure.md`]
-   **Mocking:** Frontend development must be unblocked by creating mock handlers in `msw` for the new authentication endpoints. [Source: `docs/prd/06-section-6-epic-details.md#story-111`]

### **Testing:**
-   **Strategy:** Follow the layered testing strategy. Use `@axe-core/react` for local accessibility checks. Write E2E tests with `cypress-axe` to validate the full login flow against WCAG 2.1 AA. [Source: `docs/front-end-spec.md#section-7-accessibility-requirements`]
-   **Backend:** Unit tests for authentication logic should not hit the database. Integration tests should use a test database to verify the full flow.
-   **Frontend:** Use `msw` to mock API responses for different scenarios (success, invalid password, invalid PIN) in `vitest` unit tests.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-11 | 1.0 | Initial draft of the story. | Bob, Scrum Master |

## QA Results

### Review Date: 2025-10-11

### Reviewed By: Quinn (Test Architect)

### Story Draft Assessment
This review is based on the story draft's readiness for implementation.

*   **Requirements Traceability:** Excellent. The tasks are well-defined and clearly mapped to the acceptance criteria. The flow from user need to technical task is logical and easy to follow.
*   **Technical Guidance & Alignment:** Excellent. The story correctly and consistently references the project's core technical and design principles, including the mandatory use of `shadcn/ui`, Tailwind CSS, `TanStack Query`, and `msw` for mocking. The specified file paths align with the project's defined structure.
*   **UI/UX Specification Alignment:** Excellent. The tasks demonstrate a clear understanding of the `front-end-spec.md`, incorporating requirements for branding (colors, fonts), accessibility (focus states, labels, WCAG target), and component usage.
*   **Testability:** High. The story includes a comprehensive testing task that specifies the required tools, levels (unit, integration), and strategies, aligning perfectly with the project's testing standards. The inclusion of `cypress-axe` for automated accessibility validation is a key strength.
*   **Risk Mitigation:** Good. For a high-risk authentication feature, the story correctly specifies security measures like password hashing and a two-factor flow. The detailed testing requirements further mitigate implementation risk.

### Improvements Checklist
The story is well-prepared. The following are minor suggestions for the development team to keep in mind:
- [ ] Ensure robust server-side validation is implemented for all incoming data on the API endpoints (e.g., email format, PIN length).
- [ ] Pay close attention to the secure creation, storage, and transmission of the temporary and long-lived session tokens.

### Gate Status
*   **Gate:** PASS
*   **Reason:** The story draft is comprehensive, clear, and demonstrates excellent alignment with project standards and specifications. It provides a high degree of confidence that the feature can be implemented correctly.

### Recommended Status
*   [âœ“] Ready for `Approved` status.
