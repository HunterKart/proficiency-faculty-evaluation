# Risk Profile: Story 1.2 - Database and AI Environment Setup

Date: 2025-10-10
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 4
- Critical Risks: 1
- High Risks: 2
- Risk Score: 58/100

The primary risk for this story is **Critical** and relates to data integrity. The automated generation of the database schema is highly likely to have discrepancies from the formal design, which could lead to significant rework and data corruption if not caught early.

## Critical Risks Requiring Immediate Attention

### 1. [DATA-001]: Incomplete or Incorrect Schema Migration

**Score: 9 (Critical)**
**Probability**: High - Alembic's `autogenerate` feature is powerful but notoriously imperfect. It often fails to detect changes in constraints, indexes, or complex relationship patterns.
**Impact**: High - An incorrect schema is foundational technical debt. It will cause downstream implementation failures, data integrity violations, and will require a complex, subsequent migration to fix, potentially leading to data loss.
**Mitigation**:
- **Immediate Action Required**: The developer **must** perform a manual diff between the generated migration script and the canonical DDL located in `docs/architecture/09-database-schema.md`.
- **Add to Story Tasks**: A new sub-task should be added for this manual verification step.
**Testing Focus**:
- An integration test must be created that not only runs the migration but also performs simple `SELECT` queries against several key tables to confirm their existence and basic structure.

## Risk Distribution

### By Category
- Data: 1 risk (1 critical)
- Technical: 2 risks (0 critical)
- Operational: 1 risk (0 critical)

### By Component
- Database: 3 risks
- Infrastructure: 1 risk

## Detailed Risk Register

| Risk ID  | Description                          | Probability | Impact     | Score | Priority | Mitigation Strategy                                                                                                                                                           |
| :--- | :--- | :--- | :--- | :--- | :--- |:--- |
| DATA-001 | Incomplete or Incorrect Schema Migration | High (3)    | High (3)   | 9     | Critical | **Preventive**: Manually diff generated migration against DDL. Add integration test to verify table creation.                                                              |
| TECH-001 | Incorrect Alembic Configuration      | Medium (2)  | High (3)   | 6     | High     | **Preventive**: Ensure `sqlalchemy.url` is read from env vars. Verify `env.py` targets the correct `Base.metadata`. The successful migration run is the primary validation. |
| TECH-002 | SQLAlchemy Model Mismatch            | Medium (2)  | High (3)   | 6     | High     | **Preventive**: Pay close attention to relationship configurations (`back_populates`). Add integration tests that exercise model relationships (CRUD on related objects).      |
| OPS-001  | Worker Dockerfile Build Failure      | Medium (2)  | Medium (2) | 4     | Medium   | **Preventive**: Pin AI/ML library versions in `requirements.txt`. Use a multi-stage build if necessary to manage system-level dependencies.                               |


## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests
- **Scenario: Schema Verification**
  - **Action:** After running `alembic upgrade head`, connect to the database and manually run `SHOW TABLES;` and `DESCRIBE <table>;` for at least `users`, `evaluation_submissions`, and `evaluation_form_templates`.
  - **Expected:** The output exactly matches the structure defined in `09-database-schema.md`.
- **Scenario: Idempotency Check**
  - **Action:** Run the migration command twice in a row.
  - **Expected:** The second run completes without errors and reports "no new revisions to apply".

### Priority 2: High Risk Tests
- **Scenario: Model Relationship Integrity**
  - **Action:** Write an integration test that creates a `University`, a `User` for that university, a `Role`, and links them via the `user_roles` association.
  - **Expected:** The relationships can be traversed from the `User` object and the `Role` object correctly.

### Priority 3: Medium/Low Risk Tests
- **Scenario: Worker Image Build**
  - **Action:** Run `docker-compose build worker`.
  - **Expected:** The image builds successfully without any installation errors.

## Risk Acceptance Criteria

### Must Fix Before Production
- All identified risks must be addressed as per the mitigation strategies. The residual risk for all is considered low and acceptable for this foundational story.

