# Story 1.2: Database and AI Environment Setup

## Status

Ready for Review

## Story

**As a** Super Admin/Developer,
**I want** the database schema to be initialized and the AI model environment to be prepared,
**so that** the core data structures are in place and future AI-related development is streamlined.

## Acceptance Criteria

1. A database migration tool is integrated into the backend service.
2. An initial migration script is created that generates all necessary tables as defined/referenced in the `architecture.md` within the Data Model (`docs/architecture/04-data-models.md`) and Database Schema (`docs/architecture/09-database-schema.md`) sections.
3. The migration can be successfully run via a command within the local Docker environment.
4. A dedicated `Dockerfile` for the RQ worker is created, which installs all required Python libraries for the AI/ML models (XLM-ROBERTa, KeyBERT, Gemini API, etc.) to prevent slow builds in later epics.

## Dev Notes

This story focuses on establishing the database schema and preparing the environment for AI-related tasks.

### **Database Migration**

-   **Tooling:** Use `Alembic` for database migrations, as specified in the tech stack. [Source: `docs/architecture/03-tech-stack.md`]
-   **Configuration:** Configure `alembic.ini` to connect to the MariaDB database defined in `docker-compose.yml`. The `script_location` should point to `apps/api/alembic`.
-   **Initial Migration:** Create an initial migration script that generates all tables defined in `docs/architecture/09-database-schema.md`. This script should be idempotent.
-   **Execution:** The migration should be runnable via a command like `docker-compose run api alembic upgrade head`.

### **AI Worker Environment**

-   **Dockerfile:** The `apps/api/worker.Dockerfile` should be updated to include the installation of all AI/ML libraries.
-   **Libraries:** The following libraries must be installed in the worker's Docker image:
    -   `transformers`
    -   `torch`
    -   `keybert`
    -   `google-generativeai`
    -   `scikit-learn`
        [Source: `docs/architecture/03-tech-stack.md`]
-   **Purpose:** Installing these libraries now, even if they are not used until later epics, prevents slow build times in the future when they are needed.

### **Data Models**

-   **SQLAlchemy Models:** All tables defined in `docs/architecture/09-database-schema.md` must be implemented as SQLAlchemy models in the `apps/api/src/models/` directory. [Source: `docs/architecture/11-backend-architecture.md`]
-   **Relationships:** Ensure all relationships (one-to-one, one-to-many, many-to-many) are correctly defined in the SQLAlchemy models, including back-references.

## Tasks / Subtasks

-   [x] **Task 1: Integrate and Configure Alembic (AC: 1)**
    -   [x] Initialize Alembic in the `apps/api` directory.
    -   [x] Configure `alembic.ini` with the correct database URL and script location.
    -   [x] Update `env.py` to correctly target the SQLAlchemy models' metadata.
-   [x] **Task 2: Create Initial Database Migration (AC: 2)**
    -   [x] Generate an initial migration script using `alembic revision --autogenerate`.
    -   [x] Verify that the generated script includes all tables and relationships from the schema.
-   [x] **Task 3: Implement SQLAlchemy Models (AC: 2)**
    -   [x] Create Python files in `apps/api/src/models/` for each table group defined in the data models.
    -   [x] Implement all tables as SQLAlchemy classes, ensuring all columns, types, and constraints match the DDL.
-   [x] **Task 4: Verify Migration Execution (AC: 3)**
    -   [x] Add a script or command to `package.json` to run the database migration (e.g., `pnpm db:migrate`).
    -   [x] Run the migration within the Docker environment and verify that all tables are created successfully in the MariaDB container.
-   [x] **Task 5: Update Worker Dockerfile (AC: 4)**
    -   [x] Modify `apps/api/worker.Dockerfile` to add a `pip install` step for all required AI/ML libraries.
    -   [x] Build the worker image to confirm that all dependencies install correctly.

## Testing

-   **Integration Test:** An integration test should be created to verify that the database connection is successful and that the initial migration can be applied.
-   **Manual Verification:** Manually connect to the database after migration to confirm that all tables and columns have been created as expected.

## Dev Agent Record

### Agent Model Used

-   GPT-5 (Codex CLI) — Full Stack Developer persona (James)

### Debug Log References

-   Pytest run stalls locally (pyenv shim conflict); refer to CLI output timestamped 2025-10-10T00:57Z when re-running tests.
-   MariaDB migration verified via `pnpm db:migrate` inside Docker; see CLI output timestamped 2025-10-10T10:51Z for full log.
-   Worker image build completed with `docker compose build worker`; captured at 2025-10-10T14:53Z due to large dependency downloads.
-   Containerized pytest pass recorded at 2025-10-10T17:23Z (`docker compose run --rm --no-deps api pytest`).
-   Post-QA pytest verification with enhanced schema coverage logged at 2025-10-10T17:44Z (`docker compose run --rm --no-deps api pytest`).

### Completion Notes

-   Added Alembic configuration, env module wiring, and generated `e7bc8b1da6f7_initial_schema` covering the full schema blueprint.
-   Implemented comprehensive SQLAlchemy models split across domain modules with shared enum utilities.
-   Created migration integration test at `apps/api/tests/db/test_migrations.py` to guarantee `alembic upgrade head` succeeds and key tables exist.
-   Reordered migration DDL to satisfy MySQL foreign keys and validated end-to-end via `pnpm db:migrate` against the MariaDB service.
-   Built the worker image to completion, confirming transformers/torch/KeyBERT/Gemini installs succeed in Docker.
-   Updated migration integration test to respect `DATABASE_URL` overrides so SQLite runs cleanly inside the containerized pytest job.
-   Enhanced migration integration test to assert idempotent upgrades, schema constraints, and ORM relationships covering QA findings.
-   FastAPI health test updated to use scoped client context to avoid lingering TestClient state.

### File List

-   apps/api/alembic.ini
-   apps/api/alembic/env.py
-   apps/api/alembic/script.py.mako
-   apps/api/alembic/versions/e7bc8b1da6f7_initial_schema.py
-   apps/api/src/core/config.py
-   apps/api/src/db/**init**.py
-   apps/api/src/models/**init**.py
-   apps/api/src/models/academic.py
-   apps/api/src/models/ai_reporting.py
-   apps/api/src/models/analysis.py
-   apps/api/src/models/common.py
-   apps/api/src/models/enums.py
-   apps/api/src/models/evaluation_config.py
-   apps/api/src/models/evaluation_submission.py
-   apps/api/src/models/identity.py
-   apps/api/src/models/operations.py
-   apps/api/tests/db/**init**.py
-   apps/api/tests/db/test_migrations.py
-   apps/api/tests/test_main.py
-   apps/api/worker.Dockerfile
-   package.json

### Change Log

-   2025-10-10: Completed schema models, Alembic setup, migration test, and worker image dependency prep (James).
-   2025-10-10: Resolved MariaDB migration FK ordering, executed containerized migration/tests, and confirmed worker image build (James).
-   2025-10-10: Added idempotency and schema/relationship assertions to migration integration test to close QA gaps (James).

## QA Results

### Review Date: 2025-10-10

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

-   Confirmed Alembic environment loads metadata from `src.db.Base` and honors `DATABASE_URL`; MariaDB run via `pnpm db:migrate` (2025-10-10T10:51Z) completed without foreign-key errors after DDL reordering.
-   Conditional foreign-key creation for `departments.head_user_id` preserves MySQL enforcement while keeping SQLite-based test runs green.
-   Worker Dockerfile pins required AI dependencies; build succeeded (2025-10-10T14:53Z) though image size is large as expected for torch/transformers.

### Test Coverage Assessment

-   Latest containerized pytest run (`docker compose run --rm --no-deps api pytest`, 2025-10-10T17:50Z) exercises the enhanced migration integration, confirming idempotent reruns and structural assertions.
-   Test `apps/api/tests/db/test_migrations.py::test_initial_migration_executes` now verifies Alembic head revision, key table columns/indexes, FK targets, and traverses University → Department → Program relationships.
-   Existing API smoke test continues to pass; no unmet scenarios remain in the QA test design.

### NFR & Operational Notes

-   Security/Performance: No sensitive surface changes; migrations operate at deploy time only. No concerns.
-   Reliability: Repeated migrations validated; only benign SQLAlchemy overlap warnings observed, logged for future model tuning.
-   Maintainability: Structural assertions and ORM traversal guard against schema drift; residual risk low.

### Risks & Debt

-   No open risks; DATA-001 mitigations fully automated. Monitor SQLAlchemy overlap warnings in later model work.

### Recommended Actions

None.

### Gate Recommendation

-   **Decision:** PASS – All previously identified gaps are now covered by automated tests.
-   **Suggested Next Status:** Ready for Done.
